<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Lanzador de dados â€“ DyD</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#0b1220ee; --card:#0f172acc; --text:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; --ok:#22c55e;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .app{min-height:100%;display:flex;flex-direction:column}
    header{position:sticky;top:0;z-index:10;background:var(--panel);backdrop-filter:blur(8px);border-bottom:1px solid #ffffff22}
    .hdr{max-width:980px;margin:0 auto;padding:14px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .title{font-weight:800;letter-spacing:.3px}
    .subtitle{color:var(--muted);font-size:.92rem}
    main{flex:1}
    .wrap{max-width:980px;margin:0 auto;padding:16px}

    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media(min-width:760px){.grid{grid-template-columns:repeat(4,minmax(0,1fr));}}

    .card{background:var(--card);border:1px solid #ffffff22;border-radius:16px;padding:12px;box-shadow:0 10px 30px #0006;display:flex;flex-direction:column;gap:10px}
    .icon{position:relative;height:110px;border-radius:12px;background:linear-gradient(145deg,#0e162b,#0a1120);display:grid;place-items:center;border:1px solid #ffffff1a;overflow:hidden}
    .icon img.base{width:96px;height:96px;object-fit:contain;image-rendering:crisp-edges}
    .sprite{position:absolute;inset:8px;display:grid;place-items:center;border-radius:12px;pointer-events:none}
    .sprite img{width:96px;height:96px;object-fit:contain}
    .sprite.fadeout{animation:fadeOut .22s ease both}
    @keyframes fadeOut{from{opacity:1;transform:scale(1)}to{opacity:0;transform:scale(.98)}}

    .row{display:flex;justify-content:space-between;align-items:center}
    .label{font-weight:700}
    .muted{color:var(--muted);font-size:.9rem}

    .qty{display:flex;align-items:center;gap:8px}
    .qty button{appearance:none;border:none;background:#111827;color:#e5e7eb;border:1px solid #ffffff22;width:38px;height:38px;border-radius:12px;font-size:18px;font-weight:800;cursor:pointer}
    .qty .count{min-width:28px;text-align:center;font-weight:800}

    .footerBar{position:sticky;bottom:0;background:var(--panel);backdrop-filter:blur(8px);border-top:1px solid #ffffff22}
    .footerWrap{max-width:980px;margin:0 auto;padding:12px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .summary{color:var(--muted)}
    .btnPrimary{appearance:none;border:none;background:var(--accent);color:#0b1220;font-weight:800;padding:12px 16px;border-radius:14px;box-shadow:0 10px 24px #0008;cursor:pointer}
    .btnPrimary:disabled{opacity:.5;cursor:not-allowed}

    /* Modal */
    .modal{position:fixed;inset:0;background:#0009;display:none;align-items:center;justify-content:center;z-index:40}
    .modal.show{display:flex}
    .modalCard{background:var(--panel);border:1px solid #ffffff22;border-radius:16px;padding:16px 14px;min-width:min(92vw,520px)}
    .modalHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .total{font-size:28px;font-weight:900;color:#fff}
    .badge{background:#16a34a22;color:#86efac;border:1px solid #16a34a55;padding:4px 8px;border-radius:999px;font-weight:700}
    .modalActions{display:flex;justify-content:flex-end;gap:10px;margin-top:12px}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 12px;cursor:pointer}
    .btnGhost{background:transparent;border:1px solid #ffffff44;color:#e5e7eb}
    .btnOk{background:var(--ok);color:#0b1220;font-weight:800}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="hdr">
        <div>
          <div class="title">Lanzador de dados â€“ Dungeons & Dragons</div>
          <div class="subtitle">Sprites simples (1 PNG + 1 animaciÃ³n por dado). Resultado solo en el modal.</div>
        </div>
        <div class="muted" id="selCounter">0 seleccionados</div>
      </div>
    </header>

    <main>
      <div class="wrap">
        <div class="grid" id="diceGrid"></div>
      </div>
    </main>

    <div class="footerBar">
      <div class="footerWrap">
        <div class="summary" id="summary">Sin dados seleccionados.</div>
        <button id="btnRoll" class="btnPrimary" disabled>ðŸŽ² Lanzar dados</button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modalCard">
      <div class="modalHead">
        <div class="total" id="total">Total: 0</div>
        <div class="badge" id="badge"></div>
      </div>
      <div class="modalActions">
        <button class="btn btnGhost" id="btnClose">Cerrar</button>
        <button class="btn btnOk" id="btnAgain">Lanzar de nuevo</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // === DADOS y SPRITES (1 PNG estÃ¡tico + 1 WEBP/GIF de animaciÃ³n por tipo) ===
    const DICE = [
      {key:'d2',  sides:2,  label:'D2'},
      {key:'d4',  sides:4,  label:'D4'},
      {key:'d6',  sides:6,  label:'D6'},
      {key:'d8',  sides:8,  label:'D8'},
      {key:'d10', sides:10, label:'D10'},
      {key:'d12', sides:12, label:'D12'},
      {key:'d20', sides:20, label:'D20'},
      {key:'d100',sides:100,label:'D100'},
    ];

    // Ajusta las rutas a tus archivos reales
    const SPRITES = {
      d2:  { icon: 'assets/d2/die.png',  roll: 'assets/d2/roll.webp' },
      d4:  { icon: 'assets/d4/die.png',  roll: 'assets/d4/roll.webp' },
      d6:  { icon: 'assets/d6/die.png',  roll: 'assets/d6/roll.webp' },
      d8:  { icon: 'assets/d8/die.png',  roll: 'assets/d8/roll.webp' },
      d10: { icon: 'assets/d10/die.png', roll: 'assets/d10/roll.webp' },
      d12: { icon: 'assets/d12/die.png', roll: 'assets/d12/roll.webp' },
      d20: { icon: 'assets/d20/die.png', roll: 'assets/d20/roll.webp' },
      d100:{ icon: 'assets/d100/die.png',roll: 'assets/d100/roll.webp' },
    };

    const state = Object.fromEntries(DICE.map(d=>[d.key,0]));
    const grid = document.getElementById('diceGrid');
    const btnRoll = document.getElementById('btnRoll');
    const selCounter = document.getElementById('selCounter');
    const summary = document.getElementById('summary');

    const modal = document.getElementById('modal');
    const totalEl = document.getElementById('total');
    const badgeEl = document.getElementById('badge');
    const btnClose = document.getElementById('btnClose');
    const btnAgain = document.getElementById('btnAgain');

    // Render inicial
    grid.innerHTML = DICE.map(d=>cardHTML(d)).join('');

    // Fijamos handlers correctamente (evita el bug de 'âˆ’' Unicode)
    for (const d of DICE){
      const minus = document.querySelector(`[data-key="${d.key}"][data-action="dec"]`);
      const plus  = document.querySelector(`[data-key="${d.key}"][data-action="inc"]`);
      minus.addEventListener('click', ()=> adjust(d.key,-1));
      plus.addEventListener('click',  ()=> adjust(d.key,+1));
    }

    updateUI();

    function cardHTML(d){
      const files = SPRITES[d.key]||{};
      const iconSrc = files.icon || fallbackIconData(d.key);
      return `
      <div class="card" data-type="${d.key}">
        <div class="icon" data-key="${d.key}"><img class="base" alt="${d.label}" src="${iconSrc}"/></div>
        <div class="row"><div class="label">${d.label}</div><div class="muted">${d.sides} caras</div></div>
        <div class="row qty">
          <button data-key="${d.key}" data-action="dec" aria-label="menos">âˆ’</button>
          <div class="count" data-role="count" data-key="${d.key}">0</div>
          <button data-key="${d.key}" data-action="inc" aria-label="mÃ¡s">+</button>
        </div>
      </div>`;
    }

    function adjust(key,delta){
      state[key] = Math.max(0, state[key]+delta);
      updateUI();
    }

    function updateUI(){
      for (const d of DICE){
        const cnt = document.querySelector(`[data-key="${d.key}"][data-role="count"]`);
        if (cnt) cnt.textContent = state[d.key];
      }
      const arr = DICE.filter(d=>state[d.key]>0).map(d=>`${state[d.key]}Ã—${d.label}`);
      const total = DICE.reduce((acc,d)=>acc+state[d.key],0);
      selCounter.textContent = `${total} seleccionados`;
      summary.textContent = arr.length? arr.join(' Â· ') : 'Sin dados seleccionados.';
      btnRoll.disabled = total===0;
    }

    // Lanzamiento secuencial (animaciÃ³n en la propia carta). Sin nÃºmeros en sprites.
    btnRoll.addEventListener('click', doRoll);
    btnAgain.addEventListener('click', ()=>{ modal.classList.remove('show'); doRoll(); });
    btnClose.addEventListener('click', ()=> modal.classList.remove('show'));

    async function doRoll(){
      const queue = [];
      for (const d of DICE){ for(let i=0;i<state[d.key];i++) queue.push({key:d.key,sides:d.sides}); }
      if (!queue.length) return;
      btnRoll.disabled = true;
      let total = 0;
      for (const item of queue){
        const v = await animateOnCard(item.key);  // solo animaciÃ³n
        // cÃ¡lculo lÃ³gico del valor (no visible en sprite)
        total += 1 + Math.floor(Math.random()*item.sides);
      }
      btnRoll.disabled = false;
      showTotal(total, queue.length);
    }

    function animateOnCard(key){
      return new Promise((resolve)=>{
        const icon = document.querySelector(`.icon[data-key='${key}']`);
        if (!icon) return resolve();
        const spr = document.createElement('div');
        spr.className = 'sprite';
        const img = document.createElement('img');
        const conf = SPRITES[key];
        if (conf && conf.roll){ img.src = conf.roll; }
        else { img.src = fallbackRollData(key); }
        spr.appendChild(img); icon.appendChild(spr);
        setTimeout(()=>{ spr.classList.add('fadeout'); setTimeout(()=>{ spr.remove(); resolve(); }, 220); }, 1000);
      });
    }

    function showTotal(sum, count){
      totalEl.textContent = `Total: ${sum}`;
      badgeEl.textContent = `${count} dado${count!==1?'s':''}`;
      modal.classList.add('show');
    }

    // ====== FALLBACKS (por si no subes aÃºn imÃ¡genes) ======
    function fallbackIconData(key){
      // simple SVG sin nÃºmeros, color por tipo
      const colors = { d2:'#f59e0b', d4:'#2563eb', d6:'#eab308', d8:'#10b981', d10:'#9333ea', d12:'#84cc16', d20:'#ef4444', d100:'#8b5cf6' };
      const c = colors[key]||'#38bdf8';
      const shape = key==='d6' ? 'square' : (key==='d4'?'tri':'poly');
      let svg='';
      if (shape==='square'){
        svg = `<svg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'><rect x='16' y='16' width='68' height='68' rx='14' fill='${c}'/></svg>`;
      } else if (shape==='tri'){
        svg = `<svg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'><polygon points='50,14 86,86 14,86' fill='${c}'/></svg>`;
      } else {
        svg = `<svg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'><polygon points='50,12 86,38 74,84 26,84 14,38' fill='${c}'/></svg>`;
      }
      return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
    }

    function fallbackRollData(key){
      // GIF/WEBP simulado con SVG animado (simple) por si no hay roll.webp
      const c = '#ffffff';
      const svg = `<svg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'>
        <circle cx='50' cy='50' r='36' fill='none' stroke='${c}' stroke-width='6' stroke-linecap='round'>
          <animateTransform attributeName='transform' type='rotate' from='0 50 50' to='360 50 50' dur='0.9s' repeatCount='indefinite'/>
        </circle>
      </svg>`;
      return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
    }
  })();
  </script>
</body>
</html>
